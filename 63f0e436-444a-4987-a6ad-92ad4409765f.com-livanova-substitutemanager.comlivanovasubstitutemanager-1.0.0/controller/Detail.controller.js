sap.ui.define(["jquery.sap.global","sap/ui/model/json/JSONModel","./BaseController","com/livanova/substitutemanager/CustomControls/WorkflowListControl","sap/ui/core/Fragment","sap/ui/model/Filter","sap/ui/model/FilterOperator"],function(t,e,i,s,o,a,r){"use strict";return i.extend("com.livanova.substitutemanager.controller.Detail",{onInit:function(){this.oRouter=this.getOwnerComponent().getRouter();this.oModel=this.getOwnerComponent().getModel();this.oRouter.getRoute("detail").attachPatternMatched(this.onDataMatched,this)},onSaveSuccess:function(){this.refreshEditModel();this.getModel("viewModel").setProperty("/editDetail",false);this.changeEditInProgress();sap.ui.core.BusyIndicator.hide();this.comunicationSuccess()},onSaveError:function(){this.refreshEditModel();this.getModel("viewModel").setProperty("/editDetail",false);this.changeEditInProgress();sap.ui.core.BusyIndicator.hide();this.comunicationError()},loadSubstitutesModel:function(t,e,i,s){var o=this.getModel("viewModel")?this.getModel("viewModel").getProperty("/dateChanged"):undefined;if(o){var l=this.getModel("viewModel").getProperty("/startDateSubList");var d=this.getModel("viewModel").getProperty("/endDateSubList");var n=[];n.push(new a("ValidFrom",r.EQ,this.fixDate(l)));n.push(new a("ValidTo",r.EQ,this.fixDate(d)))}this.getModel("approversMgmtModel").read("/SubstituteSet",{filters:n,success:function(e){this.fixDateVisualization(e.results);this.updateFilters(e.results);this.getModel("substitutesModel").setData(e.results);this.getModel("substitutesModel").refresh(true);this.getModel("activeSubstituteModel").setData(Object.assign([],e.results));this.getModel("activeSubstituteModel").refresh(true);var s=e.results.findIndex(function(t){return t.Id===i.Id&&i.ValidFrom>=t.ValidFrom&&i.ValidTo<=t.ValidTo});if(s>=0){this._substitute=s;var o=this.getOwnerComponent().getHelper().getNextUIState(1);this.oRouter.navTo("detail",{layout:o.layout,substitute:this._substitute})}t()}.bind(this),error:function(t){e()}.bind(this),groupId:s})},adjustChanges:function(t,e){var i=[];var s;if(t.ValidFrom!==e.ValidFrom){var o={};o.Id=t.Id;o.Name=t.Name;if(e.ValidFrom>t.ValidFrom){o.ValidFrom=t.ValidFrom;s=new Date(e.ValidFrom);s.setDate(s.getDate()-1);o.ValidTo=s;o.Active=false}else{o.ValidFrom=e.ValidFrom;s=new Date(t.ValidFrom);s.setDate(s.getDate()-1);o.ValidTo=s;o.Active=true}o.ValidFrom=this.fixDate(o.ValidFrom);o.ValidTo=this.fixDate(o.ValidTo);i.push(o)}if(t.ValidTo!==e.ValidTo){var a={};a.Id=t.Id;a.Name=t.Name;if(e.ValidTo>t.ValidTo){s=new Date(t.ValidTo);s.setDate(s.getDate()+1);a.ValidFrom=s;a.ValidTo=e.ValidTo;a.Active=true}else{s=new Date(e.ValidTo);s.setDate(s.getDate()+1);a.ValidFrom=s;a.ValidTo=t.ValidTo;a.Active=false}a.ValidFrom=this.fixDate(a.ValidFrom);a.ValidTo=this.fixDate(a.ValidTo);i.push(a)}return i},handleFullScreen:function(){var t=this.oModel.getProperty("/actionButtonsInfo/midColumn/fullScreen");this.oRouter.navTo("detail",{layout:t,substitute:this._substitute})},handleExitFullScreen:function(){var t=this.oModel.getProperty("/actionButtonsInfo/midColumn/exitFullScreen");this.oRouter.navTo("detail",{layout:t,substitute:this._substitute})},handleClose:function(t){var e=this.getModel("viewModel").getProperty("/add");if(e){function i(){this.getModel("viewModel").setProperty("/add",false);this.changeEditInProgress();var t=this.oModel.getProperty("/actionButtonsInfo/midColumn/closeColumn");this.oRouter.navTo("master",{layout:t})}this.confirmUndo(i.bind(this))}else{if(t){this.checkEditInProgress()}var s=this.oModel.getProperty("/actionButtonsInfo/midColumn/closeColumn");this.oRouter.navTo("master",{layout:s})}},onDataMatched:function(t){this._substitute=t.getParameter("arguments").substitute||this._substitute||"0";this.refreshEditModel();if(!this.getModel("viewModel").getProperty("/add")){this.getView().bindElement({path:"/"+this._substitute,model:"substitutesModel"});var e=this.getModel("substitutesModel").getProperty("/"+this._substitute);var i=new s({approverData:e,controller:this});var o=this.getView().byId("workflowVbox");o.removeAllItems();o.addItem(i)}},refreshEditModel:function(){var t=this.getModel("substitutesModel").getProperty("/"+this._substitute);var e=this.getModel("substitutesEditModel").getData();if(!e.ValidFrom){}else{t=!t?e:t}var i=Object.assign({},t);this.getModel("substitutesEditModel").setData(i);this.getModel("substitutesEditModel").refresh(true);if(t){this.onCreateSpecialDates(t.Id,["datePicker1","datePicker2"]);this.setDelimitedDates()}},setDelimitedDates:function(){var t=this.getModel("substitutesEditModel").getData();var e=["datePicker1","datePicker2"];var i=this.getView().byId("datePicker1");var s=this.getView().byId("datePicker2");var o=new Date(this.getModel("viewModel").getProperty("/today"));try{var a=this.getModel("approversListModel").getData().find(function(e){return e.Id===t.Id});if(t.ValidFrom>=o){if(a){if(a.ValidFrom<=o){i.setMinDate(o)}else{i.setMinDate(a.ValidFrom)}s.setMaxDate(a.ValidTo)}else{i.setMinDate(o);s.setMaxDate(null)}i.setMaxDate(t.ValidTo);s.setMinDate(t.ValidFrom)}else{if(t.ValidTo>=o){s.setMinDate(o);if(a){s.setMaxDate(a.ValidTo)}else{s.setMaxDate(null)}}}}catch(t){s.setMinDate(o);s.setMaxDate(null)}},onEditDetail:function(t){this.getModel("viewModel").setProperty("/editDetail",true);this.changeEditInProgress()},onSaveDetail:function(t){var e=this.getModel("substitutesEditModel").getData();var i=this.getModel("substitutesModel").getProperty("/"+this._substitute);var s=this.adjustChanges(i,e);this.onSaveChanges(s)},onUndoDetail:function(t){function e(){this.getModel("viewModel").setProperty("/editDetail",false);this.changeEditInProgress();this.refreshEditModel()}this.confirmUndo(e.bind(this))},onDeleteDetail:function(){function t(){this.handleClose(false);var t=this.getModel("substitutesModel").getProperty("/"+this._substitute);t.Active=false;t.ValidFrom=this.fixDate(t.ValidFrom);t.ValidTo=this.fixDate(t.ValidTo);this.onSaveChanges([t])}var e=this.getView().getModel("i18n").getResourceBundle();var i=e.getText("deleteSubstitute");this.confirmUndo(t.bind(this),i)}})});
sap.ui.define(["sap/ui/model/json/JSONModel","./BaseController","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/model/Sorter","sap/m/MessageBox","sap/ui/core/Fragment"],function(e,t,i,s,o,r,a){"use strict";return t.extend("com.livanova.substitutemanager.controller.Master",{onInit:function(){this.oRouter=this.getOwnerComponent().getRouter();this._bDescendingSort=false},onAfterRendering:function(){this.onFilterActiveSubstitute();this.onRefresh(true)},handleChangeDate:function(e){e.getSource().getSpecialDates();this.onCreateSpecialDates("",["dateRange"]);var t=this.getModel("viewModel").getProperty("/today");var i=new Date(t);this.getView().byId("dateRange").setMinDate(i)},onListItemPress:function(e){this.checkEditInProgress();var t=this.substitute;var i=this.getOwnerComponent().getHelper().getNextUIState(1);var s=e.getSource().getBindingContext("substitutesModel")?e.getSource().getBindingContext("substitutesModel").getPath():e.getSource().getBindingContext("activeSubstituteModel").getPath();this.substitute=s.split("/").slice(-1).pop();this.oRouter.navTo("detail",{layout:i.layout,substitute:this.substitute})},onSearch:function(e){var t=[],o=e.getParameter("query");if(o&&o.length>0){t=[new i("Name",s.Contains,o)]}this.onFiltersApply(t,true)},onSort:function(e){if(!this.popoverSort){this.popoverSort=sap.ui.xmlfragment("com.livanova.substitutemanager.view.fragments.SorterSubstitutesPopover",this);this.getView().addDependent(this.popoverSort)}this.popoverSort.openBy(e.getSource())},sortTable:function(e){var t={};var i=e.getSource().getCustomData();for(var s=0;s<e.getSource().getCustomData().length;s++){t[i[s].getKey()]=i[s].getValue()}var r=new o(t.path,t.descending==="true");this.getView().byId("substitutesTable").getBinding("items").sort(r);this.popoverSort.close()},onRefresh:function(e){var t=[];if(!(e===true)){var o=this.getModel("viewModel").getProperty("/startDateSubList");var r=this.getModel("viewModel").getProperty("/endDateSubList");t.push(new i("ValidFrom",s.EQ,this.fixDate(o)));t.push(new i("ValidTo",s.EQ,this.fixDate(r)))}sap.ui.core.BusyIndicator.show();this.getModel("approversMgmtModel").read("/SubstituteSet",{filters:t,success:function(t){this.fixDateVisualization(t.results);this.updateFilters(t.results);this.onFiltersApply("refresh");this.getModel("substitutesModel").setData(t.results);this.getModel("substitutesModel").refresh(true);var i=this.getView().getModel("i18n").getResourceBundle();var s=i.getText("updated");sap.ui.core.BusyIndicator.hide();if(!(e===true)){this.comunicationSuccess(i,s)}}.bind(this),error:function(e){sap.ui.core.BusyIndicator.hide();this.comunicationError(e)}.bind(this)})},onChangeView:function(e){var t=this.getOwnerComponent().getModel("editInProgressModel").getData().value;this.onCreateSpecialDates("",["dateRange"])},onFilter:function(e){if(!this.filterDialog){a.load({name:"com.livanova.substitutemanager.view.fragments.FilterDialog",controller:this}).then(function(e){this.filterDialog=e;this.filterDialog.setModel(this.getModel("viewModel"),"viewModel");this.filterDialog.setModel(this.getOwnerComponent().getModel("i18n"),"i18n");this.filterDialog.open()}.bind(this))}else{this.filterDialog.open()}},onFilterCancel:function(e){var t=this.getModel("substitutesModel").getData();this.updateFilters(t)},onFilterReset:function(e){var t=this.getModel("substitutesModel").getData();this.filterDialog=undefined;this.onRefresh(true)},onSaveAddDetail:function(e){var t=this.getModel("substitutesAddModel").getData();if(!t.Id){var i=this.getView().getModel("i18n").getResourceBundle();var s=i.getText("substituteMissing");this.comunicationWarning(i,s);return}t.Active=true;t.ValidFrom=this.fixDate(t.ValidFrom);t.ValidTo=this.fixDate(t.ValidTo);this.onSaveChanges([t])},onRefreshAddModel:function(){var e=this.getModel("viewModel").getProperty("/today");var t=new Date(e);var i=new Date(e);this.getModel("substitutesAddModel").setData({});this.getModel("substitutesAddModel").refresh(true);this.getModel("substitutesAddModel").setProperty("/ValidFrom",t);this.getModel("substitutesAddModel").setProperty("/ValidTo",i)},onSaveSuccess:function(){sap.ui.core.BusyIndicator.hide();this.onRefreshAddModel();this.comunicationSuccess()},onSaveError:function(){sap.ui.core.BusyIndicator.hide();this.onRefreshAddModel();this.comunicationError()},onCancelActiveSubstitute:function(){var e=this.getView().getModel("i18n").getResourceBundle();var t=e.getText("confirmCancelActiveSubstitute");function i(){var e=new Date;var t=this.getModel("viewModel").getProperty("/today");var i=this.getModel("substitutesModel").getData().find(function(e){return e.ValidFrom<=t&&e.ValidTo>=t});if(i.ValidTo.toDateString()!==t.toDateString()){i.ValidFrom=new Date(t);i.ValidFrom.setDate(t.getDate()+1);i.ValidFrom=this.fixDate(i.ValidFrom);i.ValidTo=this.fixDate(i.ValidTo);i.Active=false;this.onSaveChanges([i])}}this.confirmUndo(i.bind(this),t)},loadSubstitutesModel:function(e,t,o,r){var a=this.getModel("viewModel")?this.getModel("viewModel").getProperty("/dateChanged"):undefined;if(a){var n=this.getModel("viewModel").getProperty("/startDateSubList");var d=this.getModel("viewModel").getProperty("/endDateSubList");var l=[];l.push(new i("ValidFrom",s.EQ,this.fixDate(n)));l.push(new i("ValidTo",s.EQ,this.fixDate(d)))}this.getModel("approversMgmtModel").read("/SubstituteSet",{filters:l,success:function(t){this.fixDateVisualization(t.results);this.updateFilters(t.results);this.getModel("substitutesModel").setData(t.results);this.getModel("substitutesModel").refresh(true);this.getModel("activeSubstituteModel").setData(Object.assign([],t.results));this.getModel("activeSubstituteModel").refresh(true);e()}.bind(this),error:function(e){t()}.bind(this),groupId:r})},onOpenApproversList:function(e){this.getModel("approversMgmtModel").read("/PossibleSubstituteSet",{success:function(e){this.getModel("approversListModel").setData(e.results);this.getModel("approversListModel").refresh(true);this.getModel("viewModel").setProperty("/loadApprovers",false)}.bind(this),error:function(e){this.getModel("viewModel").setProperty("/loadApprovers",false);this.comunicationError(e)}.bind(this)});if(!this.getView().byId("approversListDialogTable")){a.load({id:this.getView().getId(),name:"com.livanova.substitutemanager.view.fragments.ApproversListDialog",controller:this}).then(function(e){this.getView().addDependent(e);e.open()}.bind(this))}else{this.getView().byId("approversListDialogTable").getBinding("items").filter([],"Application");this.getView().byId("approversListDialogTable").open()}},handleCloseApproversDialog:function(e){this.getModel("viewModel").setProperty("/loadApprovers",true);var t=this.getView().getModel("approversListModel"),i=t.getProperty("/");var s=this.getModel("substitutesAddModel");var o=i.some(function(e){if(e.selected){s.setProperty("/Id",e.Id);s.setProperty("/Name",e.Name);this.setDelimitedDates(e);return true}}.bind(this))},setDelimitedDates:function(e){var t=this.getView().byId("dateRange");var i=this.getModel("viewModel").getProperty("/today");var s=new Date(i);var o=new Date(i);s=e.ValidFrom<=s?s:e.ValidFrom;o=e.ValidTo;t.setMinDate(s);t.setMaxDate(o)},handleSearchApproversDialog:function(e){var t=[],o=e.getParameter("value");if(o&&o.length>0){t=[new i("Name",s.Contains,o)]}this.getView().byId("approversListDialogTable").getBinding("items").filter(t,"Application")},onFilterActiveSubstitute:function(){var e=this.getView().getModel("viewModel").getProperty("/today");var t=[new i("ValidFrom",s.LE,e)];t.push(new i("ValidTo",s.GE,e));this.getView().byId("activeSubstituteTable").getBinding("items").filter(t,"Application")},onChangeFilterDate:function(e){this.getModel("viewModel").setProperty("/dateChanged",e)}})});
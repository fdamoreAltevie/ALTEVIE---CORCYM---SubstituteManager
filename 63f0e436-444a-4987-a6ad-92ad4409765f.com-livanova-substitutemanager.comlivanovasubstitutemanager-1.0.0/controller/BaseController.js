sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","sap/m/MessageToast","sap/ui/core/UIComponent","sap/ui/core/routing/History","com/livanova/substitutemanager/formatters/formatter","sap/m/MessageBox","sap/ui/model/Filter","sap/ui/model/FilterOperator"],function(e,t,i,o,r,n,s,a,d){"use strict";return e.extend("com.livanova.substitutemanager.controller.BaseController",{formatter:n,onInit:function(){},refreshModels:function(){},destroyEditModel:function(){this.getModel("substitutesEditModel").setData({});this.getModel("substitutesEditModel").refresh(true)},getModel:function(e){return this.getView().getModel(e)},setModel:function(e,t){return this.getView().setModel(e,t)},comunicationError:function(e,t,i){if(!t){t=this.getView().getModel("i18n").getResourceBundle()}if(e&&e.statusCode==="400"){var o=JSON.parse(e.responseText);i=o.error.message.value}else{if(!i){i=t.getText("errCom")}}s.error(i,{title:t.getText("err")})},comunicationSuccess:function(e,t){if(!e){e=this.getView().getModel("i18n").getResourceBundle()}if(!t){t=e.getText("succCom")}i.show(t)},comunicationWarning:function(e,t){if(!e){e=this.getView().getModel("i18n").getResourceBundle()}if(!t){t=""}s.warning(t,{title:e.getText("att")})},confirmUndo:function(e,t){var i=this.getView().getModel("i18n").getResourceBundle();if(!t){t=i.getText("cancelChanges")}s.confirm(t,{title:i.getText("att"),onClose:function(t){if(t==="OK"){e()}}});return},checkEditInProgress:function(e){var t=this.getModel("i18n").getResourceBundle();var i=t.getText("editInProgress");var o=this.getOwnerComponent().getModel("editInProgressModel").getData().value;if(o){this.comunicationWarning(t,i);throw i}},fixDate:function(e){if(e.getMinutes()===59){e.setHours(0,0,0,0)}if(e.getHours()===0){e=new Date(e);e.setMinutes(-e.getTimezoneOffset())}return e},fixDateVisualization:function(e){if(e.length>0){e.forEach(function(e){var t=Object.keys(e);for(var i=0;i<t.length;i++){var o=e[t[i]];if(o instanceof Date){o=new Date(o);o.setMinutes(o.getTimezoneOffset());e[t[i]]=o}}})}return e},changeEditInProgress:function(e){var t=this.getOwnerComponent().getModel("editInProgressModel");var i=t.getProperty("/value");i=t.setProperty("/value",!i)},updateFilters:function(e){var t=[];var i=[];if(e.length>0){e.forEach(function(e){var t=i.find(function(t){return t.Id===e.Id});if(!t){i.push({Name:e.Name,Id:e.Id})}})}this.getOwnerComponent().getModel("viewModel").setProperty("/filterSubList",i);var o=this.getModel("viewModel").getProperty("/dateChanged");if(!o){var r=this.getModel("viewModel").getProperty("/today");var n=new Date(r);var s=new Date(r);for(var a=0;a<e.length;a++){n=e[a].ValidFrom<=n?e[a].ValidFrom:n;s=e[a].ValidTo>=s?e[a].ValidTo:s}this.getOwnerComponent().getModel("viewModel").setProperty("/startDateSubList",n);this.getOwnerComponent().getModel("viewModel").setProperty("/endDateSubList",s)}},fixFilterDates:function(){var e=this.getModel("viewModel").getProperty("/startDateSubList");var t=this.getModel("viewModel").getProperty("/endDateSubList");var i=Object.assign([],this.getModel("substitutesModel").getData());if(i.length>0){var o=i.find(function(t){return t.ValidFrom<e&&t.ValidTo>e});var r=i.find(function(e){return e.ValidFrom<t&&e.ValidTo>t});if(o){e=new Date(o.ValidFrom);this.getModel("viewModel").setProperty("/startDateSubList",e)}if(r){t=new Date(r.ValidTo);this.getModel("viewModel").setProperty("/endDateSubList",t)}}},onFiltersApply:function(e,t){var i=[];var o=this.getModel("viewModel")?this.getModel("viewModel").getProperty("/dateChanged"):undefined;var r=this.getModel("viewModel").getProperty("/startDateSubList");var n=this.getModel("viewModel").getProperty("/endDateSubList");if(e){var s={};if(this.filterDialog){s=this.filterDialog.getSelectedFilterKeys()}if(t){i=i.concat(e)}var l=Object.keys(s);if(l.length>0){var u=[];for(var g=0;g<l.length;g++){u.push(new a("Id",d.EQ,l[g]))}i.push(new a(u,false))}}if(e!=="refresh"&&o===true){this.reloadTable(r,n)}this.getView().byId("substitutesTable").getBinding("items").filter(i,"Application");this.changeFilterInserted()},reloadTable:function(e,t){var i=[];i.push(new a("ValidFrom",d.EQ,this.fixDate(e)));i.push(new a("ValidTo",d.EQ,this.fixDate(t)));sap.ui.core.BusyIndicator.show();this.getModel("approversMgmtModel").read("/SubstituteSet",{filters:i,success:function(e){this.fixDateVisualization(e.results);this.getModel("substitutesModel").setData(e.results);this.getModel("substitutesModel").refresh(true);sap.ui.core.BusyIndicator.hide()}.bind(this),error:function(e){sap.ui.core.BusyIndicator.hide();this.comunicationError(e)}.bind(this)})},changeFilterInserted:function(){var e=false;var t=this.getModel("viewModel")?this.getModel("viewModel").getProperty("/dateChanged"):undefined;var i=this.filterDialog;if(t){e=true}if(i){if(i.getSelectedFilterItems().length>0){e=true}}this.getModel("viewModel").setProperty("/filterInserted",e)},getResourceBundle:function(){return this.getOwnerComponent().getModel("i18n").getResourceBundle()},onSaveChanges:function(e){if(e.length===0){this.onSaveSuccess();return}var t=this.checkValidityPeriod(e);var i=this.getOwnerComponent().getModel("approversMgmtModel");var o=this;function r(e,t){i.create("/SubstituteSet",e,{success:function(i){if(!t){o.loadSubstitutesModel(o.onSaveSuccess.bind(o),o.onSaveError.bind(o),i)}else{e=t;r(e)}}.bind(o),error:function(e){o.onSaveError()}.bind(o)})}if(t){sap.ui.core.BusyIndicator.show();r(e[0],e[1])}},checkValidityPeriod:function(e){var t=e[0].Id;var i=true;var o=this.getModel("substitutesModel").getData().filter(function(e){return e.Id!==t});o.forEach(function(t){for(var o=0;o<e.length;o++){var r=new Date(this.fixDate(t.ValidFrom));var n=new Date(this.fixDate(t.ValidTo));if(e[o].ValidFrom<=n&&e[o].ValidTo>=r){i=false}}}.bind(this));if(!i){var r=this.getModel("i18n").getResourceBundle();var n=r.getText("validityWarning");this.comunicationWarning(r,n)}return i},onCreateSpecialDates:function(e,t){t.forEach(function(e){this.getView().byId(e).removeAllSpecialDates()}.bind(this));var i=this.getModel("substitutesModel").getData();if(i.length>0){i.forEach(function(e){for(var i=0;i<t.length;i++){var o=new sap.ui.unified.DateTypeRange({startDate:e.ValidFrom,endDate:e.ValidTo,type:"Type02"});this.getView().byId(t[i]).addSpecialDate(o)}}.bind(this))}}})});